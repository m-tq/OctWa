<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sample dApp - Octra Integration</title>
  <link rel="icon" type="image/png" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNk+M9QDwADhgGAWjR9awAAAABJRU5ErkJggg==">
  <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --background: #0a0a0a;
      --foreground: #e5e5e5;
      --card: #141414;
      --card-foreground: #e5e5e5;
      --primary: #0000db;
      --primary-foreground: #ffffff;
      --secondary: #1f1f1f;
      --secondary-foreground: #e5e5e5;
      --muted: #292929;
      --muted-foreground: #8c8c8c;
      --border: #2a2a2a;
      --destructive: #ef4444;
      --success: #22c55e;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    html, body {
      height: 100%;
      overflow: hidden;
    }

    body {
      font-family: 'Fira Code', monospace;
      background-color: var(--background);
      color: var(--foreground);
      display: flex;
      flex-direction: column;
    }

    /* Header */
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem 2rem;
      border-bottom: 1px solid var(--border);
      background: var(--card);
      flex-shrink: 0;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      font-size: 1rem;
      font-weight: 600;
    }

    .logo-icon {
      width: 28px;
      height: 28px;
      background: var(--primary);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
      font-size: 0.875rem;
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .connection-badge {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.375rem 0.75rem;
      background: var(--secondary);
      border: 1px solid var(--border);
      font-size: 0.75rem;
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--destructive);
    }

    .status-dot.connected {
      background: var(--success);
    }

    /* Main Content */
    .main {
      flex: 1;
      display: grid;
      grid-template-columns: 1fr 1fr;
      grid-template-rows: 1fr 1fr;
      gap: 1px;
      background: var(--border);
      overflow: hidden;
    }

    .panel {
      background: var(--card);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .panel-header {
      padding: 0.75rem 1rem;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-shrink: 0;
    }

    .panel-title {
      font-size: 0.8125rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .panel-content {
      flex: 1;
      padding: 1rem;
      overflow-y: auto;
    }

    /* Buttons */
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.375rem;
      padding: 0.5rem 1rem;
      font-family: inherit;
      font-size: 0.75rem;
      font-weight: 500;
      cursor: pointer;
      border: 1px solid transparent;
      transition: all 0.15s;
    }

    .btn-primary {
      background: var(--primary);
      color: var(--primary-foreground);
    }

    .btn-primary:hover:not(:disabled) {
      opacity: 0.9;
    }

    .btn-primary:disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }

    .btn-secondary {
      background: var(--secondary);
      color: var(--secondary-foreground);
      border-color: var(--border);
    }

    .btn-secondary:hover:not(:disabled) {
      background: var(--muted);
    }

    .btn-destructive {
      background: var(--destructive);
      color: white;
    }

    .btn-sm {
      padding: 0.25rem 0.5rem;
      font-size: 0.6875rem;
    }

    .btn-group {
      display: flex;
      gap: 0.5rem;
    }

    /* Form Elements */
    .form-group {
      margin-bottom: 0.75rem;
    }

    .form-label {
      display: block;
      margin-bottom: 0.375rem;
      font-size: 0.6875rem;
      color: var(--muted-foreground);
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .form-input, .form-select, .form-textarea {
      width: 100%;
      padding: 0.5rem;
      background: var(--secondary);
      border: 1px solid var(--border);
      color: var(--foreground);
      font-family: inherit;
      font-size: 0.75rem;
    }

    .form-input:focus, .form-select:focus, .form-textarea:focus {
      outline: none;
      border-color: var(--primary);
    }

    .form-textarea {
      resize: none;
    }

    .form-checkbox {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.75rem;
    }

    /* Info Grid */
    .info-grid {
      display: grid;
      gap: 0.5rem;
    }

    .info-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.375rem 0;
      border-bottom: 1px solid var(--border);
      font-size: 0.75rem;
    }

    .info-row:last-child {
      border-bottom: none;
    }

    .info-label {
      color: var(--muted-foreground);
    }

    .info-value {
      font-family: 'Fira Code', monospace;
      color: var(--foreground);
    }

    /* Capability List */
    .capability-list {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .capability-item {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.625rem;
      background: var(--secondary);
      border: 1px solid var(--border);
      font-size: 0.75rem;
    }

    .capability-icon {
      font-size: 1rem;
    }

    .capability-info {
      flex: 1;
      min-width: 0;
    }

    .capability-name {
      font-weight: 500;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .capability-methods {
      font-size: 0.6875rem;
      color: var(--muted-foreground);
    }

    .scope-badge {
      padding: 0.125rem 0.375rem;
      font-size: 0.625rem;
      text-transform: uppercase;
      font-weight: 600;
      flex-shrink: 0;
    }

    .scope-read { background: #14532d; color: #86efac; }
    .scope-write { background: #78350f; color: #fde68a; }
    .scope-compute { background: #581c87; color: #d8b4fe; }

    .empty-state {
      text-align: center;
      padding: 2rem;
      color: var(--muted-foreground);
      font-size: 0.75rem;
    }

    /* Log Area */
    .log-area {
      flex: 1;
      background: var(--secondary);
      border: 1px solid var(--border);
      font-size: 0.6875rem;
      overflow-y: auto;
    }

    .log-entry {
      padding: 0.375rem 0.5rem;
      border-bottom: 1px solid var(--border);
      display: flex;
      gap: 0.5rem;
    }

    .log-entry:last-child {
      border-bottom: none;
    }

    .log-time {
      color: var(--muted-foreground);
      flex-shrink: 0;
    }

    .log-message {
      word-break: break-all;
    }

    .log-success { color: var(--success); }
    .log-error { color: var(--destructive); }
    .log-info { color: var(--primary); }

    /* Alert */
    .alert {
      padding: 0.75rem;
      border: 1px solid var(--border);
      margin-bottom: 0.75rem;
      display: flex;
      align-items: flex-start;
      gap: 0.5rem;
      font-size: 0.75rem;
      background: #78350f;
      border-color: #f59e0b;
    }

    /* Scrollbar */
    ::-webkit-scrollbar {
      width: 6px;
      height: 6px;
    }

    ::-webkit-scrollbar-track {
      background: var(--secondary);
    }

    ::-webkit-scrollbar-thumb {
      background: var(--muted);
    }

    ::-webkit-scrollbar-thumb:hover {
      background: var(--muted-foreground);
    }
  </style>
</head>
<body>
  <!-- Header -->
  <header class="header">
    <div class="logo">
      <div class="logo-icon">O</div>
      <span>Sample dApp</span>
    </div>
    <div class="header-right">
      <div class="connection-badge">
        <div class="status-dot" id="status-dot"></div>
        <span id="connection-text">Disconnected</span>
      </div>
      <div class="btn-group">
        <button id="btn-connect" class="btn btn-primary btn-sm" onclick="handleConnect()">Connect</button>
        <button id="btn-disconnect" class="btn btn-destructive btn-sm" onclick="handleDisconnect()" disabled>Disconnect</button>
      </div>
    </div>
  </header>

  <!-- Extension Alert (hidden by default) -->
  <div id="extension-status" class="alert" style="display: none; margin: 0; border-left: none; border-right: none; border-top: none;">
    <span>‚ö†Ô∏è</span>
    <div>
      <strong>Octra Wallet not detected</strong> - Please install the extension.
    </div>
  </div>

  <!-- Main Content -->
  <main class="main">
    <!-- Panel 1: Session State -->
    <div class="panel">
      <div class="panel-header">
        <div class="panel-title">üìä Session State</div>
      </div>
      <div class="panel-content">
        <div class="info-grid" id="session-info">
          <div class="info-row">
            <span class="info-label">Connected</span>
            <span class="info-value" id="info-connected">false</span>
          </div>
          <div class="info-row">
            <span class="info-label">Circle</span>
            <span class="info-value" id="info-circle">-</span>
          </div>
          <div class="info-row">
            <span class="info-label">Session ID</span>
            <span class="info-value" id="info-session">-</span>
          </div>
          <div class="info-row">
            <span class="info-label">Wallet PubKey</span>
            <span class="info-value" id="info-pubkey">-</span>
          </div>
          <div class="info-row">
            <span class="info-label">Network</span>
            <span class="info-value" id="info-network">-</span>
          </div>
          <div class="info-row">
            <span class="info-label">Capabilities</span>
            <span class="info-value" id="info-caps">0</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Panel 2: Request Capability -->
    <div class="panel">
      <div class="panel-header">
        <div class="panel-title">üîê Request Capability</div>
        <button id="btn-request-cap" class="btn btn-primary btn-sm" onclick="handleRequestCapability()" disabled>Request</button>
      </div>
      <div class="panel-content">
        <div class="form-group">
          <label class="form-label">Scope</label>
          <select id="cap-scope" class="form-select">
            <option value="read">Read - View data only</option>
            <option value="write">Write - Modify data</option>
            <option value="compute">Compute - Execute operations</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Methods</label>
          <input type="text" id="cap-methods" class="form-input" value="getData, setData, processData">
        </div>
        <label class="form-checkbox">
          <input type="checkbox" id="cap-encrypted">
          <span>Encrypted payloads</span>
        </label>
      </div>
    </div>

    <!-- Panel 3: Active Capabilities + Invoke -->
    <div class="panel">
      <div class="panel-header">
        <div class="panel-title">‚úÖ Capabilities</div>
      </div>
      <div class="panel-content" style="display: flex; flex-direction: column; gap: 0.75rem;">
        <div id="capabilities-list" class="capability-list" style="flex: 1; overflow-y: auto;">
          <div class="empty-state">No capabilities granted</div>
        </div>
        <div style="border-top: 1px solid var(--border); padding-top: 0.75rem;">
          <div class="form-group" style="margin-bottom: 0.5rem;">
            <label class="form-label">Invoke Method</label>
            <div style="display: flex; gap: 0.5rem;">
              <select id="invoke-cap" class="form-select" style="flex: 1;">
                <option value="">Capability...</option>
              </select>
              <select id="invoke-method" class="form-select" style="flex: 1;">
                <option value="">Method...</option>
              </select>
            </div>
          </div>
          <button id="btn-invoke" class="btn btn-primary btn-sm" onclick="handleInvoke()" disabled style="width: 100%;">Invoke</button>
        </div>
      </div>
    </div>

    <!-- Panel 4: Activity Log -->
    <div class="panel">
      <div class="panel-header">
        <div class="panel-title">üìú Activity Log</div>
        <button class="btn btn-secondary btn-sm" onclick="clearLog()">Clear</button>
      </div>
      <div class="panel-content" style="display: flex; flex-direction: column;">
        <div id="log-area" class="log-area">
          <div class="log-entry">
            <span class="log-time">[--:--:--]</span>
            <span class="log-message log-info">Waiting for SDK...</span>
          </div>
        </div>
      </div>
    </div>
  </main>

  <script>
    // State
    let connection = null;
    let capabilities = [];
    const CIRCLE_ID = 'sample-dapp-circle';

    // Logging
    function log(message, type = 'info') {
      const logArea = document.getElementById('log-area');
      const time = new Date().toLocaleTimeString();
      const entry = document.createElement('div');
      entry.className = 'log-entry';
      entry.innerHTML = `<span class="log-time">[${time}]</span><span class="log-message log-${type}">${message}</span>`;
      logArea.appendChild(entry);
      logArea.scrollTop = logArea.scrollHeight;
    }

    function clearLog() {
      document.getElementById('log-area').innerHTML = '';
      log('Log cleared', 'info');
    }

    // UI Updates
    function updateConnectionUI() {
      const dot = document.getElementById('status-dot');
      const text = document.getElementById('connection-text');
      const btnConnect = document.getElementById('btn-connect');
      const btnDisconnect = document.getElementById('btn-disconnect');
      const btnRequestCap = document.getElementById('btn-request-cap');

      if (connection) {
        dot.classList.add('connected');
        text.textContent = 'Connected';
        btnConnect.disabled = true;
        btnDisconnect.disabled = false;
        btnRequestCap.disabled = false;
      } else {
        dot.classList.remove('connected');
        text.textContent = 'Disconnected';
        btnConnect.disabled = false;
        btnDisconnect.disabled = true;
        btnRequestCap.disabled = true;
      }

      updateSessionInfo();
    }

    function updateSessionInfo() {
      document.getElementById('info-connected').textContent = connection ? 'true' : 'false';
      document.getElementById('info-circle').textContent = connection?.circle || '-';
      document.getElementById('info-session').textContent = connection?.sessionId ? connection.sessionId.slice(0, 12) + '...' : '-';
      document.getElementById('info-pubkey').textContent = connection?.walletPubKey ? connection.walletPubKey.slice(0, 12) + '...' : '-';
      document.getElementById('info-network').textContent = connection?.network || '-';
      document.getElementById('info-caps').textContent = capabilities.length;
    }

    function updateCapabilitiesUI() {
      const list = document.getElementById('capabilities-list');
      const invokeCapSelect = document.getElementById('invoke-cap');

      if (capabilities.length === 0) {
        list.innerHTML = '<div class="empty-state">No capabilities granted</div>';
        invokeCapSelect.innerHTML = '<option value="">Capability...</option>';
        document.getElementById('btn-invoke').disabled = true;
        return;
      }

      list.innerHTML = capabilities.map(cap => `
        <div class="capability-item">
          <div class="capability-icon">${cap.scope === 'read' ? 'üëÅÔ∏è' : cap.scope === 'write' ? '‚úèÔ∏è' : '‚öôÔ∏è'}</div>
          <div class="capability-info">
            <div class="capability-name">${cap.id ? cap.id.slice(0, 20) + '...' : 'Unknown'}</div>
            <div class="capability-methods">${cap.methods ? cap.methods.join(', ') : '-'}</div>
          </div>
          <span class="scope-badge scope-${cap.scope}">${cap.scope}</span>
        </div>
      `).join('');

      invokeCapSelect.innerHTML = '<option value="">Capability...</option>' +
        capabilities.map((cap, i) => `<option value="${i}">${cap.scope}: ${cap.methods.slice(0, 2).join(', ')}${cap.methods.length > 2 ? '...' : ''}</option>`).join('');
    }

    function updateMethodSelect() {
      const capIndex = document.getElementById('invoke-cap').value;
      const methodSelect = document.getElementById('invoke-method');
      const btnInvoke = document.getElementById('btn-invoke');

      if (capIndex === '' || !capabilities[capIndex]) {
        methodSelect.innerHTML = '<option value="">Method...</option>';
        btnInvoke.disabled = true;
        return;
      }

      const cap = capabilities[capIndex];
      methodSelect.innerHTML = '<option value="">Method...</option>' +
        cap.methods.map(m => `<option value="${m}">${m}</option>`).join('');
    }

    document.getElementById('invoke-cap').addEventListener('change', updateMethodSelect);
    document.getElementById('invoke-method').addEventListener('change', () => {
      document.getElementById('btn-invoke').disabled = !document.getElementById('invoke-method').value;
    });

    // SDK Integration
    async function handleConnect() {
      if (!window.octra) {
        log('Octra Wallet not installed!', 'error');
        return;
      }

      log('Connecting to Circle: ' + CIRCLE_ID, 'info');

      try {
        const result = await window.octra.connect({
          circle: CIRCLE_ID,
          appOrigin: window.location.origin
        });

        connection = {
          circle: result.circle || CIRCLE_ID,
          sessionId: result.sessionId || `session-${Date.now()}`,
          walletPubKey: result.walletPubKey || result.address || 'unknown',
          network: result.network || 'testnet'
        };

        log('Connected! Wallet: ' + connection.walletPubKey.slice(0, 16) + '...', 'success');
        log('Network: ' + connection.network, 'success');

        updateConnectionUI();
      } catch (error) {
        log('Connection failed: ' + error.message, 'error');
      }
    }

    async function handleDisconnect() {
      if (!window.octra) return;

      log('Disconnecting...', 'info');

      try {
        await window.octra.disconnect();
        connection = null;
        capabilities = [];
        log('Disconnected', 'success');
        updateConnectionUI();
        updateCapabilitiesUI();
      } catch (error) {
        log('Disconnect failed: ' + error.message, 'error');
      }
    }

    async function handleRequestCapability() {
      if (!window.octra || !connection) return;

      const scope = document.getElementById('cap-scope').value;
      const methodsStr = document.getElementById('cap-methods').value;
      const encrypted = document.getElementById('cap-encrypted').checked;
      const methods = methodsStr.split(',').map(m => m.trim()).filter(m => m);

      log(`Requesting ${scope} capability: ${methods.join(', ')}`, 'info');

      try {
        const capability = await window.octra.requestCapability({
          circle: CIRCLE_ID,
          methods: methods,
          scope: scope,
          encrypted: encrypted,
          ttlSeconds: 3600
        });

        capabilities.push(capability);
        log('Capability granted: ' + capability.id, 'success');
        
        if (capability.signature) {
          log('Signed (ed25519): ' + capability.signature.slice(0, 24) + '...', 'info');
        }

        updateCapabilitiesUI();
        updateSessionInfo();
      } catch (error) {
        log('Capability request failed: ' + error.message, 'error');
      }
    }

    async function handleInvoke() {
      if (!window.octra || !connection) return;

      const capIndex = document.getElementById('invoke-cap').value;
      const method = document.getElementById('invoke-method').value;

      if (!capIndex || !method) {
        log('Select capability and method', 'error');
        return;
      }

      const capability = capabilities[capIndex];

      log(`Invoking ${method}...`, 'info');

      try {
        const result = await window.octra.invoke({
          capabilityId: capability.id,
          method: method,
          payload: null,
          nonce: Date.now(),
          timestamp: Date.now()
        });

        if (result.success) {
          log('Invocation successful!', 'success');
        } else {
          log('Invocation failed: ' + result.error, 'error');
        }
      } catch (error) {
        log('Invocation error: ' + error.message, 'error');
      }
    }

    // Initialization
    function checkExtension() {
      const statusEl = document.getElementById('extension-status');
      
      if (window.octra && window.octra.isOctra) {
        statusEl.style.display = 'none';
        log('Octra Wallet detected v' + (window.octra.version || '?'), 'success');
        
        window.octra.on('disconnect', () => {
          log('Event: disconnect', 'info');
          connection = null;
          capabilities = [];
          updateConnectionUI();
          updateCapabilitiesUI();
        });
      } else {
        statusEl.style.display = 'flex';
        log('Octra Wallet not detected', 'error');
      }
      
      updateConnectionUI();
    }

    if (window.octra) {
      checkExtension();
    } else {
      window.addEventListener('octraLoaded', checkExtension);
      setTimeout(() => {
        if (!window.octra) checkExtension();
      }, 2000);
    }
  </script>
</body>
</html>
